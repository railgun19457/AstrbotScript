import{E as L,H as v}from"./github-f6dc265f.js";import{W as T}from"./WaitingForRestart-82da020f.js";import{A as z}from"./AstrBotConfig-4a1033c3.js";import{C as H}from"./ConsoleDisplayer-92b1186c.js";import{j as u,b as s,w as o,a8 as k,T as S,ae as A,F as w,Y as b,o as i,c as _,ar as I,a9 as c,f as D,B as V,C as x,m as n,n as p,e as f,d as r,P as B,t as g,z as C,Q as P,E as M,l as E,as as F,O as W,V as G,A as U,G as j,at as q,S as R,R as N}from"./index-f4130869.js";import{u as K}from"./common-5ba6cde7.js";import{m as $}from"./marked.esm-01fb2abe.js";import"./customizer-b207e117.js";import"./config-aff687d2.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./index-34d28bc5.js";const O={class:"pl-2 pt-2 d-flex align-center pe-2"},J=n("h2",null,"✨ 插件市场",-1),Q=n("span",null,[r(" 如无法显示，请单击此按钮跳转至插件市场，复制想安装插件对应的 repo链接然后点击右下角 + 号安装，或打开链接下载压缩包安装。"),n("br"),r(" 如果因为网络问题安装失败，点击设置页选择 GitHub 加速地址。或前往仓库下载压缩包然后本地上传。 ")],-1),Y=n("small",{style:{color:"var(--v-theme-secondaryText)"}},"每个插件都是作者无偿提供的的劳动成果。如果您喜欢某个插件，请 Star！",-1),Z={key:0,class:"mt-4"},X=n("h2",null,"🥳 推荐",-1),ee={key:1,class:"mt-4"},te=n("h2",null,"📦 全部插件",-1),ae={class:"d-flex align-center",style:{"overflow-x":"auto","scrollbar-width":"thin","scrollbar-track-color":"transparent"}},le=["src"],se={key:1},oe=["href"],ne={key:2},ie={style:{"font-size":"13px"}},re={style:{"font-size":"12px"}},de={key:0},ue=["href"],he={key:1},me={key:0},ge={key:2,class:"mt-4"},pe=n("h2",null,"📦 全部插件",-1),ce=n("small",null,[n("a",{href:"https://astrbot.app/dev/plugin.html"},"插件开发文档")],-1),fe=n("small",null,[n("a",{href:"https://github.com/Soulter/AstrBot_Plugins_Collection"},"提交插件仓库")],-1),_e=n("span",{class:"text-h5"},"安装插件",-1),ke=n("h3",null,"从 GitHub 上在线下载",-1),ye=n("small",null,"请输入合法的 GitHub 仓库链接，当前仅支持 GitHub。如：https://github.com/Soulter/astrbot_plugin_aiocqhttp",-1),we=n("h3",null,"从本机上传 .zip 压缩包",-1),be=n("small",null,"请保证插件文件存在压缩包根目录中的第一个文件夹中（即类似于从 GitHub 仓库页上下载的 Zip 压缩包的格式）。",-1),De=n("br",null,null,-1),ve=n("span",{class:"text-h5"},"插件说明文档",-1),Ve=["innerHTML"],xe={key:1,class:"d-flex flex-column align-center justify-center",style:{height:"100%"}},Ce={class:"text-body-1 text-center mb-4"},Me={key:2,class:"d-flex flex-column align-center justify-center",style:{height:"100%"}},Ee=n("p",{class:"text-body-1 text-center mb-4"},[r("该插件未提供文档链接或GitHub仓库地址。"),n("br"),r("请查看插件市场或联系插件作者获取更多信息。")],-1),Le={name:"ExtensionPage",components:{ExtensionCard:L,WaitingForRestart:T,ConsoleDisplayer:H,AstrBotConfig:z},data(){return{extension_data:{data:[],message:""},extension_url:"",status:"",dialog:!1,snack_message:"",snack_show:!1,snack_success:"success",loading_:!1,upload_file:null,pluginMarketData:[],showPluginFullName:!1,loadingDialog:{show:!1,title:"加载中...",statusCode:0,result:""},readmeDialog:{show:!1,url:null,content:null,error:null},announcement:"",isListView:!0,pluginMarketHeaders:[{title:"名称",key:"name",maxWidth:"200px"},{title:"描述",key:"desc",maxWidth:"250px"},{title:"作者",key:"author",maxWidth:"90px"},{title:"Star数",key:"stars",maxWidth:"80px"},{title:"最近更新",key:"updated_at",maxWidth:"100px"},{title:"标签",key:"tags",maxWidth:"100px"},{title:"操作",key:"actions",sortable:!1}],marketSearch:"",commonStore:K(),filterKeys:["name","desc","author"]}},computed:{filteredPluginMarketData(){if(!this.marketSearch)return this.pluginMarketData;const a=this.marketSearch.toLowerCase();return this.pluginMarketData.filter(e=>this.filterKeys.some(l=>{var t;return(t=e[l])==null?void 0:t.toLowerCase().includes(a)}))},pinnedPlugins(){return this.pluginMarketData.filter(a=>a==null?void 0:a.pinned)}},mounted(){this.getExtensions(),this.loading_=!0,this.commonStore.getPluginCollections().then(a=>{this.pluginMarketData=a,this.trimExtensionName(),this.checkAlreadyInstalled(),this.checkUpdate(),this.loading_=!1}).catch(a=>{console.error("获取插件市场数据失败:",a)}),b.get("https://api.soulter.top/astrbot-announcement-plugin-market").then(a=>{let e=a.data.data;this.announcement=e.text})},methods:{open(a){a&&window.open(a,"_blank")},jumpToPluginMarket(){window.open("https://soulter.github.io/AstrBot_Plugins_Collection/plugins.json","_blank")},toast(a,e){this.snack_message=a,this.snack_show=!0,this.snack_success=e},resetLoadingDialog(){this.loadingDialog={show:!1,title:"加载中...",statusCode:0,result:""}},onLoadingDialogResult(a,e,l=2e3){this.loadingDialog.statusCode=a,this.loadingDialog.result=e,l!==-1&&setTimeout(()=>{this.resetLoadingDialog()},l)},getExtensions(){b.get("/api/plugin/get").then(a=>{this.extension_data=a.data,this.trimExtensionName(),this.checkAlreadyInstalled(),this.checkUpdate()})},trimExtensionName(){this.pluginMarketData.forEach(a=>{if(a.name){let e=a.name.trim().toLowerCase();e.startsWith("astrbot_plugin_")?a.trimmedName=e.substring(15):e.startsWith("astrbot_")||e.startsWith("astrbot-")?a.trimmedName=e.substring(8):a.trimmedName=a.name}})},checkUpdate(){const a=new Map,e=new Map;this.pluginMarketData.forEach(l=>{l.repo&&a.set(l.repo.toLowerCase(),l),e.set(l.name,l)}),this.extension_data.data.forEach(l=>{var y;const t=(y=l.repo)==null?void 0:y.toLowerCase(),m=t?a.get(t):null,d=e.get(l.name),h=m||d;h?(l.online_version=h.version,l.has_update=l.version!==h.version&&h.version!=="未知"):l.has_update=!1})},async getReadmeUrl(a){a=a.replace(/\/+$/,"");const e=a.match(/github\.com\/([^/]+)\/([^/]+)/);if(!e)throw new Error("无效的 GitHub 仓库地址");const l=e[1],t=e[2],m=`https://api.github.com/repos/${l}/${t}`;try{const h=await(await fetch(m)).json(),y=(h==null?void 0:h.default_branch)||"master";return`${a}/blob/${y}/README.md`}catch(d){return console.error("获取默认分支失败，使用 master 作为默认：",d),`${a}/blob/master/README.md`}},async showReadmeDialog(a){var e,l;this.readmeDialog.content=null,this.readmeDialog.error=null,(l=(e=a==null?void 0:a.data)==null?void 0:e.data)!=null&&l.repo?(this.readmeDialog.url=await this.getReadmeUrl(a.data.data.repo),a.data.data.readme?this.readmeDialog.content=a.data.data.readme:this.readmeDialog.error="插件未提供README文档"):(this.readmeDialog.url=null,this.readmeDialog.error="插件没有仓库信息或README文档"),this.readmeDialog.show=!0},async newExtension(){if(this.extension_url===""&&this.upload_file===null){this.toast("请填写插件链接或上传插件文件","error");return}if(this.extension_url!==""&&this.upload_file!==null){this.toast("请不要同时填写插件链接和上传插件文件","error");return}if(this.loading_=!0,this.loadingDialog.show=!0,this.upload_file!==null){this.toast("正在从文件安装插件","primary");const a=new FormData;a.append("file",this.upload_file),b.post("/api/plugin/install-upload",a,{headers:{"Content-Type":"multipart/form-data"}}).then(async e=>{if(this.loading_=!1,e.data.status==="error"){this.onLoadingDialogResult(2,e.data.message,-1);return}this.extension_data=e.data,this.upload_file="",this.onLoadingDialogResult(1,e.data.message),this.dialog=!1,this.getExtensions(),await this.showReadmeDialog(e)}).catch(e=>{this.loading_=!1,this.onLoadingDialogResult(2,e,-1)});return}else this.toast("正在从链接 "+this.extension_url+" 安装插件...","primary"),b.post("/api/plugin/install",{url:this.extension_url,proxy:localStorage.getItem("selectedGitHubProxy")||""}).then(async a=>{if(this.loading_=!1,this.toast(a.data.message,a.data.status==="ok"?"success":"error"),a.data.status==="error"){this.onLoadingDialogResult(2,a.data.message,-1);return}this.extension_data=a.data,this.extension_url="",this.onLoadingDialogResult(1,a.data.message),this.dialog=!1,this.getExtensions(),await this.showReadmeDialog(a)}).catch(a=>{this.loading_=!1,this.toast("安装插件失败: "+a,"error"),this.onLoadingDialogResult(2,a,-1)})},checkAlreadyInstalled(){var m;const a=new Set(this.extension_data.data.map(d=>{var h;return(h=d.repo)==null?void 0:h.toLowerCase()})),e=new Set(this.extension_data.data.map(d=>d.name));for(let d=0;d<this.pluginMarketData.length;d++){const h=this.pluginMarketData[d];h.installed=a.has((m=h.repo)==null?void 0:m.toLowerCase())||e.has(h.name)}let l=[],t=[];for(let d=0;d<this.pluginMarketData.length;d++)this.pluginMarketData[d].installed?l.push(this.pluginMarketData[d]):t.push(this.pluginMarketData[d]);this.pluginMarketData=t.concat(l)},openReadmeInNewTab(){this.readmeDialog.url&&window.open(this.readmeDialog.url,"_blank")},renderMarkdown(a){return a?($.setOptions({highlight:function(e,l){if(l&&v.getLanguage(l))try{return v.highlight(e,{language:l}).value}catch(t){console.error(t)}return v.highlightAuto(e).value},gfm:!0,breaks:!0,headerIds:!0,mangle:!1}),$(a)):""}}},Fe=Object.assign(Le,{setup(a){return(e,l)=>(i(),u(w,null,[s(k,null,{default:o(()=>[e.announcement?(i(),_(c,{key:0,cols:"12",md:"12"},{default:o(()=>[s(I,{color:"success",lines:"one",text:e.announcement,stacked:!1},null,8,["text"])]),_:1})):D("",!0),s(c,{cols:"12",md:"12"},{default:o(()=>[s(V,null,{default:o(()=>[s(x,null,{default:o(()=>[n("div",O,[J,s(p,{icon:"",size:"small",style:{"margin-left":"8px"},variant:"plain",onClick:l[0]||(l[0]=t=>e.jumpToPluginMarket())},{default:o(()=>[s(f,{size:"small"},{default:o(()=>[r("mdi-help")]),_:1}),s(B,{activator:"parent",location:"start","max-width":"500","open-delay":"500"},{default:o(()=>[Q]),_:1})]),_:1}),s(p,{icon:"",onClick:l[1]||(l[1]=t=>e.isListView=!e.isListView),size:"small",style:{"margin-left":"auto"},variant:"plain"},{default:o(()=>[s(f,null,{default:o(()=>[r(g(e.isListView?"mdi-view-grid":"mdi-view-list"),1)]),_:1})]),_:1}),s(C),s(P,{modelValue:e.marketSearch,"onUpdate:modelValue":l[2]||(l[2]=t=>e.marketSearch=t),density:"compact",label:"Search","prepend-inner-icon":"mdi-magnify",variant:"solo-filled",flat:"","hide-details":"","single-line":""},null,8,["modelValue"])])]),_:1}),s(M,null,{default:o(()=>[Y,e.pinnedPlugins.length>0?(i(),u("div",Z,[X,s(k,{style:{"margin-top":"8px"}},{default:o(()=>[(i(!0),u(w,null,E(e.pinnedPlugins,t=>(i(),_(c,{cols:"12",md:"6",lg:"6"},{default:o(()=>[s(L,{extension:t,class:"h-120 rounded-lg","market-mode":"true",highlight:!0,onInstall:m=>{e.extension_url=t.repo,e.newExtension()},onViewReadme:m=>e.open(t.repo)},null,8,["extension","onInstall","onViewReadme"])]),_:2},1024))),256))]),_:1})])):D("",!0),e.isListView?(i(),u("div",ee,[te,s(F,{modelValue:e.showPluginFullName,"onUpdate:modelValue":l[3]||(l[3]=t=>e.showPluginFullName=t),label:"显示完整名称","hide-details":"",density:"compact",style:{"margin-left":"12px"}},null,8,["modelValue"]),s(c,{cols:"12",md:"12",style:{padding:"0px"}},{default:o(()=>[s(W,{headers:e.pluginMarketHeaders,items:e.pluginMarketData,"item-key":"name",loading:e.loading_,search:e.marketSearch,"onUpdate:search":l[4]||(l[4]=t=>e.marketSearch=t),"filter-keys":e.filterKeys},{"item.name":o(({item:t})=>[n("div",ae,[t.logo?(i(),u("img",{key:0,src:t.logo,style:{height:"80px",width:"80px","margin-right":"8px","border-radius":"8px","margin-top":"8px","margin-bottom":"8px"},alt:"logo"},null,8,le)):D("",!0),t!=null&&t.repo?(i(),u("span",se,[n("a",{href:t==null?void 0:t.repo,style:{color:"var(--v-theme-primaryText, #000)","text-decoration":"none"}},g(e.showPluginFullName?t.name:t.trimmedName),9,oe)])):(i(),u("span",ne,g(e.showPluginFullName?t.name:t.trimmedName),1))])]),"item.desc":o(({item:t})=>[n("div",ie,g(t.desc),1)]),"item.author":o(({item:t})=>[n("div",re,[t!=null&&t.social_link?(i(),u("span",de,[n("a",{href:t==null?void 0:t.social_link},g(t.author),9,ue)])):(i(),u("span",he,g(t.author),1))])]),"item.stars":o(({item:t})=>[n("span",null,g(t.stars),1)]),"item.updated_at":o(({item:t})=>[n("span",null,g(new Date(t.updated_at).toLocaleString()),1)]),"item.tags":o(({item:t})=>[t.tags.length===0?(i(),u("span",me,"-")):D("",!0),(i(!0),u(w,null,E(t.tags,m=>(i(),_(G,{key:m,color:"primary",size:"x-small"},{default:o(()=>[r(g(m),1)]),_:2},1024))),128))]),"item.actions":o(({item:t})=>[t.installed?(i(),_(p,{key:1,class:"text-none mr-2",size:"x-small",variant:"flat",border:"",disabled:""},{default:o(()=>[s(f,null,{default:o(()=>[r("mdi-check")]),_:1})]),_:1})):(i(),_(p,{key:0,class:"text-none mr-2",size:"x-small",variant:"flat",onClick:m=>{e.extension_url=t.repo,e.newExtension()}},{default:o(()=>[s(f,null,{default:o(()=>[r("mdi-download")]),_:1})]),_:2},1032,["onClick"])),s(p,{class:"text-none mr-2",size:"x-small",variant:"flat",border:"",onClick:m=>e.open(t.repo)},{default:o(()=>[s(f,null,{default:o(()=>[r("mdi-help")]),_:1})]),_:2},1032,["onClick"])]),_:1},8,["headers","items","loading","search","filter-keys"])]),_:1})])):(i(),u("div",ge,[pe,s(k,{style:{"margin-top":"16px"}},{default:o(()=>[(i(!0),u(w,null,E(e.filteredPluginMarketData,t=>(i(),_(c,{cols:"12",md:"6",lg:"6"},{default:o(()=>[s(L,{extension:t,"market-mode":"true"},null,8,["extension"])]),_:2},1024))),256))]),_:1})]))]),_:1})]),_:1})]),_:1}),s(c,{style:{"margin-bottom":"16px"},cols:"12",md:"12"},{default:o(()=>[ce,r(" | "),fe]),_:1})]),_:1}),s(S,{modelValue:e.dialog,"onUpdate:modelValue":l[9]||(l[9]=t=>e.dialog=t),width:"700"},{activator:o(({props:t})=>[s(p,U(t,{icon:"mdi-plus",size:"x-large",style:{position:"fixed",right:"52px",bottom:"52px"},color:"darkprimary"}),null,16)]),default:o(()=>[s(V,null,{default:o(()=>[s(x,null,{default:o(()=>[_e]),_:1}),s(M,null,{default:o(()=>[s(j,null,{default:o(()=>[s(k,null,{default:o(()=>[ke,s(c,{cols:"12"},{default:o(()=>[ye,s(P,{label:"仓库链接",modelValue:e.extension_url,"onUpdate:modelValue":l[5]||(l[5]=t=>e.extension_url=t),variant:"outlined",required:""},null,8,["modelValue"])]),_:1})]),_:1}),s(k,null,{default:o(()=>[we,s(c,{cols:"12"},{default:o(()=>[be,s(q,{label:"选择文件",modelValue:e.upload_file,"onUpdate:modelValue":l[6]||(l[6]=t=>e.upload_file=t),accept:".zip",outlined:"",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),De,n("small",null,g(e.status),1)]),_:1}),s(R,null,{default:o(()=>[s(C),s(p,{color:"blue-darken-1",variant:"text",onClick:l[7]||(l[7]=t=>e.dialog=!1)},{default:o(()=>[r(" 关闭 ")]),_:1}),s(p,{color:"blue-darken-1",variant:"text",loading:e.loading_,onClick:l[8]||(l[8]=t=>e.newExtension())},{default:o(()=>[r(" 安装 ")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(A,{timeout:2e3,elevation:"24",color:e.snack_success,modelValue:e.snack_show,"onUpdate:modelValue":l[10]||(l[10]=t=>e.snack_show=t)},{default:o(()=>[r(g(e.snack_message),1)]),_:1},8,["color","modelValue"]),s(T,{ref:"wfr"},null,512),s(S,{modelValue:e.readmeDialog.show,"onUpdate:modelValue":l[14]||(l[14]=t=>e.readmeDialog.show=t),width:"800",persistent:""},{default:o(()=>[s(V,null,{default:o(()=>[s(x,{class:"d-flex justify-space-between align-center"},{default:o(()=>[ve,s(p,{icon:"",onClick:l[11]||(l[11]=t=>e.readmeDialog.show=!1)},{default:o(()=>[s(f,null,{default:o(()=>[r("mdi-close")]),_:1})]),_:1})]),_:1}),s(N),s(M,{style:{height:"70vh","overflow-y":"auto"}},{default:o(()=>[s(p,{color:"primary","prepend-icon":"mdi-open-in-new",onClick:l[12]||(l[12]=t=>e.openReadmeInNewTab()),class:"mt-4"},{default:o(()=>[r(" 在GitHub中查看文档 ")]),_:1}),e.readmeDialog.content?(i(),u("div",{key:0,class:"markdown-body",innerHTML:e.renderMarkdown(e.readmeDialog.content)},null,8,Ve)):e.readmeDialog.error?(i(),u("div",xe,[s(f,{size:"64",color:"error",class:"mb-4"},{default:o(()=>[r("mdi-alert-circle-outline")]),_:1}),n("p",Ce,g(e.readmeDialog.error),1)])):(i(),u("div",Me,[s(f,{size:"64",color:"warning",class:"mb-4"},{default:o(()=>[r("mdi-file-question-outline")]),_:1}),Ee]))]),_:1}),s(N),s(R,null,{default:o(()=>[s(C),s(p,{color:"primary",variant:"tonal",onClick:l[13]||(l[13]=t=>e.readmeDialog.show=!1)},{default:o(()=>[r(" 关闭 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});export{Fe as default};
